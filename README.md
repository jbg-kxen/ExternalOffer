# ExternalOffer server

## Requirements

ExternalOffer is an application developped by [KXEN](http://www.kxen.com).
It was developped using Ruby on Rails with a PostgreSQL database backend.
To run the application you will need the following software:

- [Ruby (version 1.9.x)](http://www.ruby-lang.org/)
- [Ruby on Rails (version 3.1)](http://rubyonrails.org/)
- [PostgreSQL](http://www.postgresql.org/)

The application connects to a Salesforce organization to retrieve the
information on a given Lead/Contact in order to apply KXEN models.
This means you will also need the following:

- A [Salesforce](http://www.salesforce.com) organization (only Enterprise
  and Unlimited editions are supported).
- The [KXEN NBA app](http://appexchange.salesforce.com/) installed on that
  organization.
- Create the appropriate Remote Sites settings in that organization so that
  the KXEN NBA app can contact the ExternalOffer server.

## Description

*ExternalOffer* is an application developped by [KXEN](http://www.kxen.com)
to demonstrates the usage of KXEN's NBA (Next Best Activity) REST API.
The application returns *Scored Offers* and stores *Responses* to these offers.
For more information on what is a *Scored Offer* and what is a *Response*
please refer to the [KXEN NBA REST API documentation].
It is a Rails web-application that serves 'Offers' and registers 'Responses' to
these offers.

## API - HTTP Requests

The application answers to HTTP request initiated by the KXEN NBA application.
The responses are formatted in [Json](http://www.json.org/) as requested by
the KXEN NBA API.

Retrieve the offers applicable to a Salesforce Lead/Contact.

>      GET /offers/<orgId>/<userId>
  Returns an array of scored offers applicable for the given salesforce
  ``<orgId>`` and ``<userId>``. The list is sorted by probability of
  acceptance. Note: ``<userId>`` must be the identifier of a valid Lead
  or Contact object.

Register acceptance of an offer by a Salesforce Lead/Contact

>      GET /offers/<orgId>/<userId>/<offerId>/accept
  Registers that the Lead or Contact identified by ``<userId>`` has accepted
  the given offers.
  Returns the same as ``GET /offers/<orgId>/<userId>`` but take into
  account that offer ``<offerId>`` was accepted by the user.

Register refusal of an offer by a Salesforce Lead/Contact

>      GET /offers/<orgId>/<userId>/<offerId>/reject
  Registers that the Lead or Contact identified by ``<userId>`` has rejected
  the given offers.
  Returns the same as ``GET /offers/<orgId>/<userId>`` but take into
  account that offer ``<offerId>`` was rejected by the user.

# Installing

## Install the application

Type the following command in a terminal/console prompt to download the
application:

    git clone https://github.com/mcasalaina/ExternalOffer.git


A folder named ``ExternalOffer`` should have been created containing the application's
files:

    +---ExternalOffer
        +---app    ------------> Holds the source code of the application
        ¦   +---controllers
        ¦   +---models
        ¦   +---views
        ¦       +---layouts
        ¦       +---offers
        +---config ------------> Configuration files of the application
        ¦   +---environments
        ¦   +---initializers
        +---db     ------------> Contains the database schema/migration files
        ¦   +---migrate
        ¦   +---udf
        +---doc
        +---lib    ------------> Application specific library
        ¦   +---tasks
        +---log
        +---public
        +---script
        +---test   ------------> Holds the source code of the application tests
        ¦   +---fixtures
        ¦   +---functional
        ¦   +---integration
        ¦   +---performance
        ¦   +---unit
        ¦       +---lib
        +---tmp

# Configuring the application

To configure the application you will have to set the following settings.
The way to do so is described in the section *Environment*.

Settings description:

You need to register a remote access for your own instance of the external
offer server. See [Salesforce documentation](http://login.salesforce.com/help/doc/en/remoteaccess_define.htm)
for more information.

- ``SF_CLIENT_ID``       : the consumer key generated by Salesforce
- ``SF_CLIENT_SECRET``   : the consumer secret generated by Salesforce
- ``SF_USERNAME``        : username used to connect to Salesforce organization
- ``SF_PASSWORD``        : password used to connect to Salesforce organization
- ``SF_SECURITY_TOKEN``  : the security token to connect to Salesforce

- ``OFFER_SERVICE_IMPL`` : The value should be ``StoredProcedureScorer``.
This setting defines which class should be instantiated to calculate the probability value.
If you plan on experimenting another way to calculate probablities, then you
might want to implement a new scorer class
and set the ``OFFER_SERVICE_IMPL`` setting value to the name of your class.
Your scorer class must implement the following method:

        score(offers, userId) -> ScoredOffer


## Setting up the environment

###### Configuring development/test environment

You will find three configuration files located in

- ``config/environments/development.rb``
- ``config/environments/production.rb`` *(detailed in the next section)*
- ``config/environments/test.rb``

If you want to run the tests or run the application locally in a developper
environment, edit the corresponding environment file and change the value
of the above-cited settings to match your particular Salesforce organization.

###### Configuring production environment

The configuration file for the production environment is:

- ``config/environments/production.rb``

By default the production environment expects to find the settings' value
in environment variables. So, in order to load the application in a production environment,
make sure you set the appropriate environment variables on the production machine.
Alternatively you can edit the the ``config/environments/production.rb`` file
and set the configuration directly in the file.

## Seed data

If you start the application without seeding some intial data, you will find
that the application returns no scored offer.
That is because the application data base is initially empty.

To populate the database with sample data, run the following commands:

        rake db:migrate
        rake db:seed
        rake udf:load

The sample data includes the following five offers and associated five KXEN
models (as SQL UDF files)

- Brokerage Account
- Checking Account
- Retirement Account
- Savings Account
- Visa Account

######To modify the sample data:

- Edit ``db/seeds.rb``: Change it to configure the offers for your Salesforce
  organization. Add as many offers as you which.
  When you are finished, run:

        rake db:seed

- Drop files in ``db/udf``: Drop any PostgreSQL udf file in this folder (must
  be a ``.SQL`` file). **Note:** *You will have to edit the source code too to
  take your models into account*.
  When you are finished, run:

        rake udf:load

## Notes on deploying the application to Heroku

    git push $APPNAME
    heroku run rake db:migrate --app $APPNAME
    heroku run rake db:seed --app $APPNAME
    heroku run rake udf:load --app $APPNAME
    heroku config SF_CLIENT_ID=xxx SF_CLIENT_SECRET=xxx SF_USERNAME=xxx SF_PASSWORD=xxx SF_SECURITY_TOKEN=xxx  --app $APPNAME

###### Configuration environment
To set the configuration for production environment you will have to set
the approriate environment variables as described in the *Configuration*
chapter.
Visit [Heroku's Configuration](https://devcenter.heroku.com/articles/config-vars)
article to see how to configure the environment variables for a heroku
application.

###### Idling applications
Be aware that if you run the application on Heroku with a single web dyno
the KXEN NBA application may fail to serve offers because Heroku can
[idle out](https://devcenter.heroku.com/articles/dynos#dyno-idling) your
application making it slow to answer queries.
And because of Salesforce platform constraints, if your application takes too
long to return the offers, the KXEN NBA application will fail to display the
offers and will display an error message instead.